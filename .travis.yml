language: php

dist: trusty

php:
    - 7.2

jobs:
    include:
        -   &test
            stage: test
            name: "Symfony 3.4.* build"

            sudo: false

            env: SYMFONY_VERSION="3.4.*" SYLIUS_CACHE_DIR=$HOME/.sylius-cache SYLIUS_BUILD_DIR=etc/build

            cache:
                yarn: true
                directories:
                    - ~/.composer/cache/files
                    - $SYLIUS_CACHE_DIR

            services:
                - memcached
                - mysql

            before_install:
                - make ci-symfony-before-install

            install:
                - make ci-symfony-install

            before_script:
                - make ci-symfony-before-script

            script:
                - make ci-symfony-script

            after_failure:
                - make ci-symfony-after-failure

        -   <<: *test

            name: "Symfony 4.1.* build"

            env: SYMFONY_VERSION="4.1.*" SYLIUS_CACHE_DIR=$HOME/.sylius-cache SYLIUS_BUILD_DIR=etc/build

        -
            stage: test
            name: "Docker build"

            sudo: required

            env: DOCKER_COMPOSE_VERSION=1.22.0

            services:
                - docker

            addons:
                apt:
                    packages:
                        - docker-ce

            before_install:
                make ci-docker-before-install

            script:
                - make ci-docker-script

            before_deploy:
                - make ci-docker-before-deploy

            deploy:
                provider: script
                script: docker-compose push
                skip_cleanup: true
                on:
                    repo: Sylius/Sylius-Standard
                    tags: true
