version: '3.4'

services:
    sylius:
        build:
            context: .
            target: sylius_server
            dockerfile: docker/sylius/Dockerfile
        image: sylius/server:latest
        healthcheck:
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 30s
        depends_on:
            - mysql
        env_file:
            - .env
        volumes:
            - .:/srv/sylius:rw,cached
            - ./public:/srv/sylius/public:rw,delegated
            - public-media:/srv/sylius/public/media:rw
            - sylius-vendor:/srv/sylius/vendor
            - sylius-node_modules:/srv/sylius/node_modules

    assets:
        build:
            context: .
            dockerfile: docker/assets/Dockerfile
            target: sylius_assets
            args:
                - APP_ENV=${APP_ENV}
        image: sylius/assets:latest
        depends_on:
            - sylius
        env_file:
            - .env
        volumes:
            - .:/srv/sylius:rw,cached
            - ./public:/srv/sylius/public:rw,delegated
            - public-media:/srv/sylius/public/media:rw
            - sylius-node_modules:/srv/sylius/node_modules
        ports:
            - "35729:35729"

    webserver:
        build:
            context: .
            target: sylius_nginx
            dockerfile: docker/nginx/Dockerfile
        image: nginx:latest
        env_file:
            - .env
        depends_on:
            - sylius
            - assets
        volumes:
            - ./public:/srv/sylius/public:ro
            - public-media:/srv/sylius/public/media:ro,delegated
        ports:
            - "80:80"

    mysql:
        image: percona:5.7
        environment:
            - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-nopassword}
            - MYSQL_DATABASE=sylius_${APP_ENV}
            - MYSQL_USER=${MYSQL_USER:-sylius}
            - MYSQL_PASSWORD=${MYSQL_PASSWORD:-nopassword}
        volumes:
            - mysql-data:/var/lib/mysql:rw
        ports:
            - "3306:3306"

    mailhog:
        # do not use in production!
        image: mailhog/mailhog:latest
        environment:
            - MH_STORAGE=maildir
        # volumes:
        #   - ./docker/mailhog/maildir:/maildir:rw,delegated
        ports:
            - "8025:8025"

volumes:
    mysql-data:
    public-media:
    sylius-vendor:
    sylius-node_modules:
